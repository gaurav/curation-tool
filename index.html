<!doctype html>
<html lang="en">

<!--
    Phyloreferencing Curation Tool
    Copyright (c) The Phyloreferencing Project, 2018.

    Skeleton based on https://www.taniarascia.com/basic-html5-file/
-->

<head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-size=1">

    <title>Phyloref Curation Tool</title>

    <!--
    <link rel="icon" href="images/favicon.png">
    -->

    <!-- Load stylesheets and IE8 support -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <link rel="stylesheet" href="./lib/phylotree.js/phylotree.css">
    <link rel="stylesheet" href="./css/main.css">

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
</head>

<body @unload="closeCurrentStudy()">

  <!-- Vue.js will execute on this element and its children -->
  <div id="app">

    <!-- Navigation bar at the top of the page -->
    <nav class="navbar navbar-default">
      <div class="container-fluid">
        <div class="navbar-header">
          <a class="navbar-brand" href="index.html">Curation Tool v{{CURATION_TOOL_VERSION}}</a>
        </div>
        <div class="collapse navbar-collapse">
          <ul class="nav navbar-nav navbar-right">
            <li><a href="#" onclick="$('#about-curation-tool').modal()">About this tool</a></li>
            <li><a href="https://www.phyloref.org/">Phyloreferencing website</a></li>
            <li><a href="https://github.com/phyloref/curation-tool">Github repository</a></li>
            <li><a href="https://github.com/phyloref/curation-tool/issues">Report bug</a></li>
          </ul>
        </div>
      </div>
    </nav>

    <!-- The wrapper adds a padding to the left, so that the sidebar can be moved there. -->
    <div id="wrapper">

      <!-- Sidebar showing phyloreferences and phylogenies -->
      <div id="sidebar-wrapper">

        <!-- Sidebar section: main menu for loading and saving PHYX files -->
        <div class="panel panel-default">
          <div class="panel-heading">Main menu</div>
          <div class="list-group">
            <a class="list-group-item" href="javascript: void(0)" onclick="$('#file-input').trigger('click')">Read from local JSON file</a>
            <input id="file-input" type="file" style="display:none;" @change="loadPHYXFromFileInputById('#file-input')">
            <a class="list-group-item" href="javascript: void(0)" @click="downloadAsJSON()">Save as JSON</a>
            <a class="list-group-item start-reasoning" href="javascript: void(0)" @click="reasonOverPhyloreferences()">Reason</a>
            <a class="list-group-item" href="javascript: void(0)" onclick="$('.phyx-examples').toggleClass('hidden')">Examples</a>
            <a href="javascript: void(0)"
                class="list-group-item phyx-examples hidden"
                v-for="example of examplePHYXURLs"
                @click="loadPHYXFromURL(example.url)"
                > &#9679; {{example.title}}</a>
            <a class="list-group-item" href="javascript: void(0)" onclick="$('#advanced-options').toggle(300)">Advanced</a>
          </div>
        </div>

        <!-- Sidebar section: information about this particular PHYX file -->
        <div class="panel panel-default">
          <div class="panel-heading" @click="promptAndSetDict('Enter a new title for this PHYX file', testcase, 'title')">
            <template v-if="testcase.title">{{testcase.title}}</template>
            <template v-else>No PHYX file loaded</template>
          </div>
          <div class="list-group">
            <a class="list-group-item" href="javascript: void(0)" @click="promptAndSetDict('Enter a new title for this PHYX file', testcase, 'title')">Change PHYX title</a>
            <a class="list-group-item" href="javascript: void(0)" @click="selectedPhyloref = undefined; selectedSpecifier = undefined; selectedPhylogeny = undefined">Display summary</a>
          </div>
        </div>

        <!-- Sidebar section: list of phyloreferences in PHYX file -->
        <div class="panel panel-default">
          <div class="panel-heading">Phyloreferences</div>

          <!-- List of phyloreferences -->
          <div class="list-group">
            <template v-for="(phyloref, phylorefIndex) of testcase.phylorefs">
              <a href="javascript: void(0)"
                class="list-group-item"
                :class="{active: selectedPhyloref === phyloref}"
                @click="resetSVG(); selectedPhyloref = phyloref; selectedSpecifier = undefined; selectedPhylogeny = undefined"
              >{{hasProperty(phyloref, 'label') ? phyloref.label : 'Phyloreference ' + (phylorefIndex + 1)}}

                <!-- Add a warning if this phyloreference has changed -->
                <span
                  v-if="!isEqualJSON(phyloref, testcaseAsLoaded.phylorefs[phylorefIndex])"
                  data-toggle="tooltip" data-placement="bottom" title="This phyloreference has been modified since being loaded! Use 'Save as JSON' to save your changes."
                  class="close glyphicon glyphicon-warning-sign"></span>
              </a>

              <!-- Add the following information if this phyloreference is selected -->
              <template v-if="selectedPhyloref === phyloref">

                <!-- Display internal specifiers -->
                <a
                  href="javascript: void(0)"
                  class="list-group-item"
                  @class="{active: selectedSpecifier === internalSpecifier}"
                  @click="resetSVG(); selectedPhyloref = phyloref; selectedSpecifier = internalSpecifier; selectedTUnit = undefined; selectedPhylogeny = undefined"
                  v-for="(internalSpecifier, internalSpecifierIndex) of phyloref.internalSpecifiers">
                  &#9679; <strong>Internal:</strong> <span v-html="getSpecifierLabelAsHTML(internalSpecifier)"></span>
                </a>

                <!-- Display external specifiers -->
                <a
                  href="javascript: void(0)"
                  class="list-group-item"
                  @class="{active: selectedSpecifier === externalSpecifier}"
                  @click="resetSVG(); selectedPhyloref = phyloref; selectedSpecifier = externalSpecifier; selectedTUnit = undefined; selectedPhylogeny = undefined"
                  v-for="(externalSpecifier, externalSpecifierIndex) of phyloref.externalSpecifiers">
                  &#9679; <strong>External:</strong> <span v-html="getSpecifierLabelAsHTML(externalSpecifier)"></span>
                </a>

                <!-- Display phylogenies -->
                <a
                  v-for="(phylogeny, phylogenyIndex) of testcase.phylogenies"
                  class="list-group-item"
                  @class="{active: selectedPhylogeny === phylogeny}"
                  href="javascript: void(0)"
                  @click="resetSVG(); selectedPhyloref = phyloref; selectedSpecifier = undefined; selectedTUnit = undefined; selectedPhylogeny = phylogeny"
                >
                  &#9679; <strong>Phylogeny:</strong>
                    <template v-if="getPhylorefExpectedNodeLabels(phylogeny, selectedPhyloref).length < 1">no expected node</template>
                    <template v-else>node expected</template>
                    in {{getPhylogenyLabel(phylogeny)}}
                </a>
              </template>
            </template>

            <!-- Let users add phyloreferences directly from the sidebar -->
            <a class="list-group-item" href="javascript: void(0)" @click="testcase.phylorefs.push(createEmptyPhyloref(testcase.phylorefs.length + 1))"><strong>Add phyloreference</strong></a>

          </div>
        </div>

        <!-- Sidebar section: list of phylogenies in PHYX file -->
        <div class="panel panel-default">
          <div class="panel-heading">Phylogenies</div>
          <div class="list-group">
            <a href="javascript: void(0)"
              class="list-group-item"
              v-for="(phylogeny, phylogenyIndex) of testcase.phylogenies"
              :class="{active: selectedPhylogeny === phylogeny}"
              @click="resetSVG(); selectedPhyloref = undefined; selectedSpecifier = undefined; selectedPhylogeny = phylogeny"
            >{{hasProperty(phylogeny, 'description') ? phylogeny.description : 'Phylogeny ' + (phylogenyIndex + 1)}}

            <!-- Add a warning if this phylogeny has changed -->
            <span
              v-if="!isEqualJSON(phylogeny, testcaseAsLoaded.phylogenies[phylogenyIndex])"
              data-toggle="tooltip" data-placement="bottom" title="This phylogeny has been modified since being loaded! Use 'Save as JSON' to save your changes."
              class="close glyphicon glyphicon-warning-sign"></span>
            </a>
            <a class="list-group-item" href="javascript: void(0)" @click="testcase.phylogenies.push({})"><strong>Add phylogeny</strong></a>
          </div>
        </div>

      </div><!-- End of sidebar -->

      <!-- Start of page content -->
      <div id="page-content-wrapper">

        <!-- The following components appear above the main panel -->

        <!-- The advanced panel provides access to advanced features of the Curation Tool -->
        <div id="advanced-options" hidden>
          <div class="panel panel-info">
            <div class="panel-heading">
              <!-- Close button for panel -->
              <a href="#" class="close" onclick="$('#advanced-options').hide(300)">&times;</a>
              Advanced options
            </div>
            <div class="panel-body">
              <p>The following is a representation of this PHYX in JSON. You
              can edit the JSON directly if you like.</p>
              <textarea id="test-content" style="width: 100%; margin: auto;" rows="10" v-model="phyxAsJSON"></textarea>
            </div>
            <div class="panel-footer">
              <div class="btn-group btn-group-justified" role="group" aria-label="Actions for phylogenies">
                <div class="btn-group" role="group">
                  <button id="download-as-jsonld-btn" type="button" class="btn btn-info" @click="downloadAsJSONLD()">Download as JSON-LD</button>
                </div>
              </div>
            </div>
          </div>
        </div><!-- End of panels above the main panel -->

        <!--
          The main panel can be in one of three states: when a phyloreference has been selected,
          when a phylogeny has been selected, or when nothing has been selected.
        -->
        <template v-if="selectedPhyloref">
          <!-- A phyloreference has been selected -->

          <!-- Add a warning if this phyloreference has changed -->
          <div
            v-if="!isEqualJSON(selectedPhyloref, testcaseAsLoaded.phylorefs[selectedPhylorefIndex])"
            class="panel panel-warning">
            <div class="panel-heading">Warning!</div>
            <div class="panel-body">
              This phyloreference has been modified since being loaded! Use 'Save as JSON' to save your changes.
            </div>
          </div>

          <!-- Phyloreference information -->
          <template v-if="selectedSpecifier === undefined && selectedPhylogeny === undefined">
            <div class="panel panel-info">
              <div class="panel-heading">Phyloreference information</div>

              <div class="panel-body">
                <div id="phyloref" class="form-horizontal">

                  <!-- Phyloreference label -->
                  <label for="label" class="control-label col-md-2 col-lg-1 col-sm-3">Label</label>
                  <div class="input-group col-md-10 col-lg-11 col-sm-9">
                    <input id="label" v-model="selectedPhyloref.label" type="text" class="form-control" placeholder="Phyloreference label">
                  </div>

                  <!-- Phyloreference clade definition -->
                  <label for="definition" class="control-label col-md-2 col-lg-1 col-sm-3">Clade definition</label>
                  <div class="input-group col-md-10 col-lg-11 col-sm-9">
                    <textarea
                      id="definition"
                      v-model.lazy="selectedPhyloref.cladeDefinition"
                      class="form-control"
                      rows="6"
                      placeholder="Phylogenetic clade definition"
                    ></textarea>
                  </div>

                  <!-- Phyloreference curator comments -->
                  <label for="curator-comments" class="control-label col-md-2 col-lg-1 col-sm-3">Curator comments</label>
                  <div class="input-group col-md-10 col-lg-11 col-sm-9">
                    <textarea
                      id="curator-comments"
                      v-model.lazy="selectedPhyloref.curatorComments"
                      class="form-control"
                      rows="2"
                      placeholder="Curator notes relating to this phyloreference"
                    ></textarea>
                  </div>
                </div>
              </div>

              <!-- List of buttons that can be used to change or modify the selected phyloreference -->
              <div class="panel-footer" v-if="selectedPhyloref !== undefined && testcase.phylorefs.indexOf(selectedPhyloref) != -1">
                <div class="btn-group btn-group-justified" role="group" aria-label="Actions for the entire phyloreference">
                  <a
                    href="#selected-phyloref"
                    class="btn btn-default"
                    @click="resetSVG(); changeSelectedPhyloref(-1)"
                  >Previous</a>
                  <div class="btn-group" role="group">
                    <button
                      id="phyloref-status"
                      type="button"
                      class="btn btn-primary dropdown-toggle"
                      data-toggle="dropdown"
                      aria-haspopup="true"
                      aria-expanded="false">
                      Status: {{ getPhylorefStatus(selectedPhyloref).statusInEnglish }} <span class="caret"></span>
                    </button>
                    <ul class="dropdown-menu">
                      <li><a href="#selected-phyloref" @click="setPhylorefStatus(selectedPhyloref, 'pso:draft')">Draft</a></li>
                      <li><a href="#selected-phyloref" @click="setPhylorefStatus(selectedPhyloref, 'pso:final-draft')">Final draft</a></li>
                      <li><a href="#selected-phyloref" @click="setPhylorefStatus(selectedPhyloref, 'pso:under-review')">Under review</a></li>
                      <li><a href="#selected-phyloref" @click="setPhylorefStatus(selectedPhyloref, 'pso:submitted')">Tested</a></li>
                      <li><a href="#selected-phyloref" @click="setPhylorefStatus(selectedPhyloref, 'pso:published')">Published</a></li>
                      <li><a href="#selected-phyloref" @click="setPhylorefStatus(selectedPhyloref, 'pso:retracted-from-publication')">Retracted</a></li>
                    </ul>
                  </div>
                  <div class="btn-group" role="group">
                    <button
                      id="phyloref-status-changes"
                      type="button"
                      class="btn btn-default dropdown-toggle"
                      data-toggle="dropdown"
                      aria-haspopup="true"
                      aria-expanded="false">
                      {{ getPhylorefStatusChanges(selectedPhyloref).length }} changes <span class="caret"></span>
                    </button>
                    <ul class="dropdown-menu">
                      <li><a href="#selected-phyloref" v-for="statusChange of getPhylorefStatusChanges(selectedPhyloref)">
                        {{ statusChange.statusInEnglish }}
                        <div style="font-size: 70%" v-if="hasProperty(statusChange, 'intervalStartAsCalendar')">{{ statusChange.intervalStartAsCalendar }}</div>
                      </a></li>
                    </ul>
                  </div>
                  <a
                    href="#selected-phyloref"
                    class="btn btn-danger"
                    onclick="if(window.confirm('Are you sure you want to delete this phyloreference?')) { vm.testcase.phylorefs.splice(vm.testcase.phylorefs.indexOf(vm.selectedPhyloref), 1); vm.selectedPhyloref = undefined; }"
                    >Delete</a>
                  <a
                    href="#selected-phyloref"
                    class="btn btn-default"
                    @click="resetSVG(); changeSelectedPhyloref(+1)"
                    >Next</a>
                </div>
              </div>
            </div>

            <!-- List of specifiers associated with this phyloreference -->
            <div id="specifiers" class="panel panel-info" style="margin-top: 1em">
              <div class="panel-heading">Specifiers</div>
              <div class="panel-body">
                <div class="input-group"
                    v-if="selectedPhyloref"
                    v-for="(specifier, specifierIndex) of getSpecifiers(selectedPhyloref)"
                    :id="'specifier-' + specifierIndex"
                >
                  <!-- Buttons before specifier label -->
                  <div class="input-group-btn">
                    <!-- Delete button: initially hidden, made visible by clicking the "Delete some specifiers" button -->
                    <button v-if="deletingSpecifiersMode" type="button"
                      class="btn btn-danger"
                      @click="deleteSpecifier(selectedPhyloref, specifier)"
                    ><span class="glyphicon glyphicon-remove"></span></button>

                    <!-- Match results with dropdown menu -->
                    <button
                      @click="dropdownTargetForSpecifier = 'matchResult'"
                      type="button" class="btn dropdown-toggle"
                      :class="{ 'btn-warning': getAllNodeLabelsMatchedBySpecifier(specifier).length == 0, 'btn-success': getAllNodeLabelsMatchedBySpecifier(specifier).length > 0}" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                      <span class="glyphicon"
                        :class="{ 'glyphicon-asterisk': getAllNodeLabelsMatchedBySpecifier(specifier).length == 0, 'glyphicon-ok': (getAllNodeLabelsMatchedBySpecifier(specifier).length > 0) || hasProperty(specifier, 'specifierWillNotMatch') }"></span>
                    </button>
                    <ul v-if="dropdownTargetForSpecifier == 'matchResult'" class="dropdown-menu dropdown-menu-left">
                      <li class="dropdown-header">Match result</li>
                      <li v-if="getAllNodeLabelsMatchedBySpecifier(specifier).length == 0">
                        <a href="#" onclick="return false;"><em>No matches</em></a>
                      </li>
                      <li v-for="(nodeLabel, nodeLabelIndex) of getAllNodeLabelsMatchedBySpecifier(specifier)">
                        <a href="#" onclick="return false;">{{nodeLabel}}</a>
                      </li>
                      <template v-if="getAllNodeLabelsMatchedBySpecifier(specifier).length === 0">
                        <li class="dropdown-header">Specifier will not match</li>
                          <li><a href="#specifiers"
                            @click="promptAndSetDict('Why couldn\'t this specifier be matched?', specifier, 'specifierWillNotMatch')"
                          >
                          <template v-if="hasProperty(specifier, 'specifierWillNotMatch')">
                            Reason <small>(click to edit)</small>: {{specifier.specifierWillNotMatch}}
                          </template>
                          <template v-else>
                            <em>No reason given: click here to set one</em>
                          </template>
                        </a></li>
                      </template>
                    </ul>
                    <ul v-if="dropdownTargetForSpecifier == 'specifierType'" class="dropdown-menu dropdown-menu-left">
                      <li class="dropdown-header">Specifier type</li>
                      <li :class="{active: getSpecifierType(selectedPhyloref, specifier) == 'Internal'}">
                        <a href="#" onclick="return false;"
                          @click="setSpecifierType(selectedPhyloref, specifier, 'Internal')"
                        >Internal specifier</a></li>
                      <li :class="{active: getSpecifierType(selectedPhyloref, specifier) == 'External'}">
                        <a href="#" onclick="return false;"
                          @click="setSpecifierType(selectedPhyloref, specifier, 'External')"
                        >External specifier</a></li>
                    </ul>

                    <!-- Specifier type with dropdown menu: internal or external specifier -->
                    <button
                      @click="dropdownTargetForSpecifier = 'specifierType'"
                      type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"
                    > {{getSpecifierType(selectedPhyloref, specifier)}} <span class="caret"></span></button>
                  </div>

                  <!-- Specifier label -->
                  <input type="text" disabled class="form-control" :value="getSpecifierLabel(specifier)" :title="getSpecifierLabel(specifier)">

                  <!-- Buttons after specifier label: edit button -->
                  <div class="input-group-btn">
                    <button type="button" class="btn btn-primary"
                      @click="startTUnitEditorModal('specifier', getSpecifierLabel(specifier), specifier)"
                    ><span class="glyphicon glyphicon-edit"></span></button>
                  </div>
                </div>
              </div>

              <!-- Add or delete specifiers -->
              <div class="panel-footer">
                <button
                  type="button"
                  class="btn btn-default"
                  onclick="vm.selectedPhyloref.externalSpecifiers.push(vm.createEmptySpecifier());"
                >Add new specifier</button>
                <button
                  type="button"
                  class="btn btn-default"
                  @click="deletingSpecifiersMode = !deletingSpecifiersMode"
                >Delete some specifiers</button>
              </div>
            </div>
          </template>

          <!-- Panels with information on the current specifier -->
          <template v-if="selectedSpecifier !== undefined">
            <label for="verbatim-specifier" class="control-label">Verbatim specifier</label>
            <input id="verbatim-specifier" type="text" class="form-control"
              v-model.trim="selectedSpecifier.verbatimSpecifier"
              placeholder="Enter the verbatim description of this specifier">

            <!-- List of taxonomic units -->
            <div id="tunits-panel" class="panel panel-info" style="margin-top: 1em">
              <div class="panel-heading">Taxonomic Units</div>
              <div class="panel-body" v-if="!selectedTUnit">
                <p><em>Select a taxonomic unit or create a new one.</em></p>
              </div>
              <div class="panel-body" v-if="selectedTUnit">
                <p>
                  Each taxonomic unit can have any number of scientific names, external
                  references and specimens. We recommend using a single taxonomic unit
                  for each type of identifier.
                </p>

                <!-- Panel listing scientific names in this taxonomic unit -->
                <div class="col-md-12">
                  <div class="panel panel-default">
                    <div class="panel-heading">Scientific names</div>
                    <div class="panel-body">
                      <span v-if="!hasProperty(selectedTUnit, 'scientificNames') || selectedTUnit.scientificNames.length == 0">
                        <em>No scientific names provided.</em>
                      </span>
                      <div class="input-group"
                        v-if="hasProperty(selectedTUnit, 'scientificNames')"
                        v-for="(scname, scnameIndex) of selectedTUnit.scientificNames">
                        <span class="input-group-btn">
                          <button type="button" class="btn btn-danger" @click="selectedTUnit.scientificNames.splice(scnameIndex, 1)"><span class="glyphicon glyphicon-remove"></span></button>
                        </span>
                        <input type="text" class="form-control" v-model.lazy="scname.scientificName">
                        <div class="input-group-btn">
                          <button type="button"
                            class="btn btn-primary dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"
                          ><span class="glyphicon glyphicon-search"></span> <span class="caret"></span></button>
                          <ul class="dropdown-menu dropdown-menu-right">
                            <li class="dropdown-header">Components of the scientific name</li>
                            <li><a href="#" onclick="return false"><em>Entered scientific name:</em> {{scname.scientificName}}</a></li>
                            <li><a href="#" onclick="return false"><em>Binomial name:</em> {{getBinomialName(scname)}}</a></li>
                            <li><a href="#" onclick="return false"><em>Genus:</em> {{getGenus(scname)}}</a></li>
                            <li><a href="#" onclick="return false"><em>Specific epithet:</em> {{getSpecificEpithet(scname)}}</a></li>
                          </ul>
                        </div>
                      </div>
                    </div>
                    <div class="panel-footer">
                      <button type="button" class="btn btn-default"
                        @click="createOrAppend(selectedTUnit, 'scientificNames', {'scientificName': ''})"
                      >Add a new scientific name</button>
                    </div>
                  </div>
                </div>

                <!-- Panel listing external references in this taxonomic unit -->
                <div class="col-md-6">
                  <div class="panel panel-default">
                  <div class="panel-heading">External references</div>
                  <div class="panel-body">
                    <span v-if="!hasProperty(selectedTUnit, 'externalReferences') || selectedTUnit.externalReferences.length == 0">
                      <em>No external references provided.</em>
                    </span>

                    <div class="input-group"
                      v-if="hasProperty(selectedTUnit, 'externalReferences')"
                      v-for="(externalRef, externalRefIndex) of selectedTUnit.externalReferences">
                      <div class="input-group-btn">
                        <button type="button" class="btn btn-danger" @click="selectedTUnit.externalReferences.splice(externalRefIndex, 1)"
                          ><span class="glyphicon glyphicon-remove"></span></button>
                      </div>
                      <input type="url" class="form-control" v-model.lazy="selectedTUnit.externalReferences[externalRefIndex]">
                      <div class="input-group-btn">
                        <button type="button" class="btn btn-primary" @click="openURL(externalRef)">Go to URL</button>
                      </div>
                    </div>

                    </div>
                    <div class="panel-footer">
                      <button
                        type="button"
                        class="btn btn-default"
                        style="width: 100%"
                        href="#specifier-modal"
                        onclick="if(!('externalReferences' in vm.selectedTUnit)) Vue.set(vm.selectedTUnit, 'externalReferences', []); vm.selectedTUnit.externalReferences.push('http://example.org/');"
                      >Add a new external reference</button>
                    </div>
                  </div>
                </div>

                <!-- Panel listing specimens in this taxonomic unit -->
                <div class="col-md-6">
                  <div class="panel panel-default">
                    <div class="panel-heading">Specimens</div>
                    <div class="panel-body">
                      <span v-if="!hasProperty(selectedTUnit, 'includesSpecimens') || selectedTUnit.includesSpecimens.length == 0">
                        <em>No specimens provided.</em>
                      </span>
                      <div class="input-group"
                        v-if="hasProperty(selectedTUnit, 'includesSpecimens')"
                        v-for="(specimen, specimenIndex) of selectedTUnit.includesSpecimens">
                        <span class="input-group-btn">
                          <button type="button" class="btn btn-danger" @click="selectedTUnit.includesSpecimens.splice(scnameIndex, 1)"><span class="glyphicon glyphicon-remove"></span></button>
                        </span>
                        <input type="text" class="form-control" v-model.lazy="specimen.occurrenceID">
                        <div class="input-group-btn">
                          <button type="button"
                            class="btn btn-primary dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"
                          ><span class="glyphicon glyphicon-search"></span> <span class="caret"></span></button>
                          <ul class="dropdown-menu dropdown-menu-right">
                            <li class="dropdown-header">Specimen components</li>
                            <li><a href="#" onclick="return false">Occurrence ID: {{specimen.occurrenceID}}</a></li>
                            <li><a href="#" onclick="return false">Institution Code: {{getInstitutionCode(specimen)}}</a></li>
                            <li><a href="#" onclick="return false">Collection Code: {{getCollectionCode(specimen)}}</a></li>
                            <li><a href="#" onclick="return false">Catalog Number: {{getCatalogNumber(specimen)}}</a></li>
                          </ul>
                        </div>
                      </div>
                    </div>
                    <div class="panel-footer">
                      <button type="button" class="btn btn-default"
                        @click="createOrAppend(selectedTUnit, 'includesSpecimens', {'occurrenceID': ''})"
                        >Add a new specimen</button>
                    </div>
                  </div>
                </div>
              </div>

              <!-- List of taxonomic units, including the option to add new taxonomic units -->
              <div class="list-group">
                <div class="list-group-item"
                  v-for="(tunit, tunitIndex) of selectedSpecifier.referencesTaxonomicUnits"
                  :class="{active: selectedTUnit === tunit}"
                  @click="selectedTUnit = tunit"
                  :title="getTaxonomicUnitLabel(tunit)"
                >{{getTaxonomicUnitLabel(tunit)}}

                <a href="#"
                  :title="'Delete ' + getTaxonomicUnitLabel(tunit)"
                  href="javascript: void(0)"
                  class="icon-danger close glyphicon glyphicon-remove"
                  @click="deleteTUnit(tunit)"></a>
              </div>
              <a class="list-group-item"
                href="javascript: void(0)"
                onclick="vm.selectedSpecifier.referencesTaxonomicUnits.push(vm.createEmptyTaxonomicUnit(vm.selectedSpecifier.referencesTaxonomicUnits.length + 1))"
                ><strong>Add new taxonomic unit</strong></a>
              </div>
            </div>
          </template>

          <!--
            Panel with information on expected and actual resolution
            We should:
              - display all phylogenies when looking up a phyloreference or specifiers
              - display only the selected phylogeny when it's selected
          -->
          <template v-for="(phylogeny, phylogenyIndex) of testcase.phylogenies">
            <template v-if="selectedPhylogeny === undefined || selectedPhylogeny === phylogeny">
              <div class="panel panel-info">
                <div class="panel-heading">Expected and actual resolution on {{getPhylogenyLabel(phylogeny)}}</div>
                <div class="panel-body">

                  <!-- Node(s) this phyloreference is expected to resolve to -->
                  <label for="curator-comments" class="control-label col-md-2">Expected nodes</label>
                  <div class="input-group col-md-10">
                    <div class="input-group">
                      <!-- Display the phylogeny where this node is expected to match -->
                      <span class="input-group-btn">
                        <a
                          class="btn btn-default"
                          :href="'#current_expected_label_phylogeny' + phylogenyIndex"
                          title="Click here to jump to the expected label"
                          type="button">Go to node</a>
                      </span>

                      <!-- Display the matching node(s) -->
                      <template v-if="getPhylorefExpectedNodeLabels(phylogeny, selectedPhyloref).length === 0">
                        <!-- We matched no nodes -->
                        <input readonly type="text" class="form-control" value="No nodes could be matched">
                      </template>

                      <template v-if="getPhylorefExpectedNodeLabels(phylogeny, selectedPhyloref).length === 1">
                        <!-- We matched exactly one node -->
                        <input readonly type="text" class="form-control" :value="getPhylorefExpectedNodeLabels(phylogeny, selectedPhyloref)[0]">
                      </template>

                      <template v-if="getPhylorefExpectedNodeLabels(phylogeny, selectedPhyloref).length > 1">
                        <!-- We matched more than one node -->
                        <input readonly type="text" class="form-control" :value="getPhylorefExpectedNodeLabels(phylogeny, selectedPhyloref).length + ' nodes matched: ' + getPhylorefExpectedNodeLabels(phylogeny, selectedPhyloref).join(', ')">
                      </template>

                      <!-- Display a dropdown menu that allows the modified label to be changed. -->
                      <div class="input-group-btn">
                        <button
                          type="button"
                          class="btn btn-primary dropdown-toggle"
                          data-toggle="dropdown"
                          aria-haspopup="true"
                          aria-expanded="false"
                          >Change <span class="caret"></span>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-right">
                          <!-- List every labeled node in this phylogeny. -->
                          <li class="dropdown-header">Labeled internal nodes in this phylogeny</li>
                          <li
                            v-for="nodeLabel of getNodeLabelsInPhylogeny(phylogeny, 'internal').sort()"
                            :class="{active: getPhylorefExpectedNodeLabels(phylogeny, selectedPhyloref).includes(nodeLabel)}"
                          >
                            <a href="#selected-phyloref" @click="togglePhylorefExpectedNodeLabel(phylogeny, selectedPhyloref, nodeLabel)">{{nodeLabel}}</a>
                          </li>
                          <li class="dropdown-header">Labeled terminal nodes in this phylogeny</li>
                          <li
                            v-for="nodeLabel of getNodeLabelsInPhylogeny(phylogeny, 'terminal').sort()"
                            :class="{active: getPhylorefExpectedNodeLabels(phylogeny, selectedPhyloref).includes(nodeLabel)}"
                          >
                            <a href="#selected-phyloref" @click="togglePhylorefExpectedNodeLabel(phylogeny, selectedPhyloref, nodeLabel)">{{nodeLabel}}</a>
                          </li>
                        </ul>
                      </div>
                    </div>
                  </div>

                  <!-- Node(s) this phyloreference actually resolved to -->
                  <label for="curator-comments" class="control-label col-md-2">Actual nodes</label>
                  <div class="input-group col-md-10">

                    <!-- If phylogenies were loaded, we need to display a selector for each phylogeny -->
                    <div class="input-group">
                      <!-- Display the phylogeny where this node is expected to match -->
                      <span class="input-group-btn">
                        <a
                          class="btn btn-default"
                          :href="'#current_pinning_node_phylogeny' + phylogenyIndex"
                          title="Click here to jump to this node"
                          type="button">Go to node</a>
                      </span>

                      <!-- Display the matching node(s) -->
                      <template v-if="!hasProperty(reasoningResults, 'phylorefs')">
                        <input readonly type="text" class="form-control" value="Click 'Reason' to reason over all phyloreferences.">
                      </template>
                      <template v-else>
                        <template v-if="getResolvedNodesForPhylogeny(selectedPhyloref, phylogeny).length === 0">
                          <!-- We matched no nodes -->
                          <input readonly type="text" class="form-control" :value="'No nodes could be matched'">
                        </template>
                        <template v-if="getResolvedNodesForPhylogeny(selectedPhyloref, phylogeny).length === 1">
                          <!-- We matched exactly one node -->
                          <input readonly type="text" class="form-control" :value="getResolvedNodesForPhylogeny(selectedPhyloref, phylogeny, false)[0]">
                        </template>
                        <template v-if="getResolvedNodesForPhylogeny(selectedPhyloref, phylogeny).length > 1">
                          <!-- We matched more than one node -->
                          <input readonly type="text" class="form-control" :value="getResolvedNodesForPhylogeny(selectedPhyloref, phylogeny).length + ' nodes matched: ' + getResolvedNodesForPhylogeny(selectedPhyloref, phylogeny, false).join(', ')">
                        </template>
                      </template>

                      <!-- Display a button that activates reasoning. -->
                      <div class="input-group-btn">
                        <button
                          type="button"
                          class="btn btn-primary start-reasoning"
                          @click="reasonOverPhyloreferences()"
                          >Reason</button>
                      </div>
                    </div>
                  </div>

                  <!-- Display the phylogeny -->
                  <div class="well" style="margin-top: 1em">
                    <svg
                      width="100%"
                      v-if="getPhylogenyParsingErrors(phylogeny).length === 0"
                      :id="'phylogeny-svg-view-' + selectedPhylorefIndex + '-phylogeny-' + phylogenyIndex"
                      :alt="getPhylogenyAsNewick('#phylogeny-svg-view-' + selectedPhylorefIndex + '-phylogeny-' + phylogenyIndex, phylogeny)"></svg>
                  </div>
                </div>
                <div class="panel-footer">
                  <div class="btn-group btn-group-justified" role="group" aria-label="Actions for phylogeny">
                    <!-- Dropdown button for vertical spacing -->
                    <div class="btn-group" role="group">
                      <button type="button" class="btn btn-default" @click="resetSVG(); renderTree('#phylogeny-svg-view-' + selectedPhylorefIndex + '-phylogeny-' + phylogenyIndex, phylogeny)">
                        Refresh
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </template>
          </template>
        </template>
        <template v-else-if="selectedPhylogeny">
          <!-- A phylogeny has been selected -->

          <!-- Add a warning if this phylogeny has changed -->
          <div
            v-if="!isEqualJSON(selectedPhylogeny, testcaseAsLoaded.phylogenies[selectedPhylogenyIndex])"
            class="panel panel-warning">
            <div class="panel-heading">Warning!</div>
            <div class="panel-body">
              This phylogeny has been modified since being loaded! Use 'Save as JSON' to save your changes.
            </div>
          </div>

          <div id="phylogeny-metadata" class="form-horizontal">
            <div class="panel panel-info">
              <div class="panel-heading">Phylogeny information</div>
              <div class="panel-body">
                <label for="title" class="col-md-2 control-label">Title</label>
                <div class="col-md-10 input-group">
                  <input id="title" type="text" class="form-control" v-model.trim="selectedPhylogeny.title" placeholder="Enter phylogeny title">
                </div>

                <label for="description" class="col-md-2 control-label">Description</label>
                <div class="col-md-10 input-group">
                    <textarea id="description" class="form-control" v-model.trim="selectedPhylogeny.description" placeholder="Enter phylogeny description"></textarea>
                </div>

                <label for="newick" class="col-md-2 control-label">Newick</label>
                <div class="col-md-10 input-group">
                  <textarea
                    rows="5"
                    class="form-control"
                    placeholder="Enter Newick string for phylogeny here"
                    v-model.lazy="selectedPhylogeny.newick"
                    >{{getPhylogenyAsNewick('#phylogeny-svg-' + selectedPhylogenyIndex, selectedPhylogeny)}}</textarea>
                </div>
              </div>
            </div>
          </div>

          <!-- Display the list of errors encountered when parsing this Newick string -->
          <div v-if="getPhylogenyParsingErrors(selectedPhylogeny).length !== 0" class="panel panel-warning">
            <div class="panel-heading">Errors occurred while parsing Newick string</div>
            <div class="panel-body">
              <template v-for="(error, errorIndex) of getPhylogenyParsingErrors(selectedPhylogeny)">
                <p><strong>{{error.title}}.</strong> {{error.message}}</p>
              </template>
            </div>
          </div>

          <!-- Display the phylogeny (unless there were Newick parsing errors) -->
          <div v-if="getPhylogenyParsingErrors(selectedPhylogeny).length === 0" class="panel panel-info">
            <div class="panel-heading">Phylogeny visualization</div>
            <div class="panel-body">
              <svg
                width="100%"
                :id="'phylogeny-svg-' + selectedPhylogenyIndex"
                :alt="getPhylogenyAsNewick('#phylogeny-svg-' + selectedPhylogenyIndex, selectedPhylogeny)"></svg>
            </div>
            <div class="panel-footer">
              <div class="btn-group btn-group-justified" role="group" aria-label="Actions for phylogeny">
                <!-- Refresh phylogeny -->
                <a href="javascript: void(0)" class="btn btn-default" @click="resetSVG(); renderTree('#phylogeny-svg-' + selectedPhylogenyIndex, selectedPhylogeny)">Refresh</a>

                <!-- Dropdown button for vertical spacing -->
                <div class="btn-group" role="group">
                  <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    Vertical spacing: {{ getPhylogenySpacingX(selectedPhylogenyIndex) }}px <span class="caret"></span>
                  </button>
                  <ul class="dropdown-menu">
                    <li><a :href="'#phylogeny-' + selectedPhylogenyIndex + '-footer'" @click="changePhylogenySpacingX(selectedPhylogenyIndex, +10)">Increase scale</a></li>
                    <li><a :href="'#phylogeny-' + selectedPhylogenyIndex + '-footer'" @click="changePhylogenySpacingX(selectedPhylogenyIndex, -10)">Decrease scale</a></li>
                  </ul>
                </div>

                <!-- Dropdown button for horizontal spacing -->
                <div class="btn-group" role="group">
                  <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    Horizontal spacing: {{ getPhylogenySpacingY(selectedPhylogenyIndex) }}px <span class="caret"></span>
                  </button>
                  <ul class="dropdown-menu">
                    <li><a :href="'#phylogeny-' + selectedPhylogenyIndex + '-footer'" @click="changePhylogenySpacingY(selectedPhylogenyIndex, +10)">Increase scale</a></li>
                    <li><a :href="'#phylogeny-' + selectedPhylogenyIndex + '-footer'" @click="changePhylogenySpacingY(selectedPhylogenyIndex, -10)">Decrease scale</a></li>
                  </ul>
                </div>

                <!--
                  <a class="btn btn-default" :href="'#phylogeny-' + phylogenyIndex" @click="editingAnnotationsForPhylogeny = (editingAnnotationsForPhylogeny === phylogeny ? undefined : phylogeny)" class="btn btn-default">Edit annotations</a>
                -->

                <!-- Button to delete this phylogeny -->
                <a class="btn btn-danger" :href="'#phylogeny-' + selectedPhylogenyIndex" @click="confirm('Are you sure you want to permanently delete this phylogeny?', () => testcase.phylogenies.splice(selectedPhylogenyIndex, 1))">Delete phylogeny</a>
              </div>
            </div>
          </div>

        </template>
        <template v-else>
          <!--
            Neither a phyloreference nor a phylogeny has been selected, so
            display a summary of the entire PHYX file instead.
          -->
          <div class="panel">
            <div class="panel-body">
              <table class="table table-hover table-bordered">
                <thead>
                  <th>&nbsp;</th>
                  <th>Phyloreference</th>
                  <th>Internal specifiers</th>
                  <th>External specifiers</th>
                  <th v-for="(phylogeny, phylogenyIndex) of testcase.phylogenies">{{getPhylogenyLabel(phylogeny)}}</th>
                </thead>
                <tbody>
                  <tr v-if="testcase.phylorefs.length === 0">
                    <td :colspan="4 + testcase.phylogenies.length"><center><em>No phyloreferences loaded</em></center></td>
                  </tr>
                  <tr v-for="(phyloref, phylorefIndex) of testcase.phylorefs">
                    <td>&nbsp;</td>
                    <td><a href="javascript: void(0)" @click="resetSVG(); selectedPhyloref = phyloref">{{getPhylorefLabel(phyloref)}}</a></td>
                    <td>{{phyloref.internalSpecifiers.length}}</td>
                    <td>{{phyloref.externalSpecifiers.length}}</td>
                    <td v-for="(phylogeny, phylogenyIndex) of testcase.phylogenies">
                      <template v-if="getPhylorefExpectedNodeLabels(phylogeny, phyloref).length === 0">
                        <strong>Not matched</strong>
                        <template v-if="hasProperty(reasoningResults, 'phylorefs')">
                          but
                          <template v-if="getNodeLabelsResolvedByPhyloref(phyloref, phylogeny) > 1">
                            <strong>resolved to multiple nodes: {{getNodeLabelsResolvedByPhyloref(phyloref, phylogeny)}}</strong>
                          </template>
                          <template v-else>
                            resolved to {{getNodeLabelsResolvedByPhyloref(phyloref, phylogeny)[0]||"(none)"}}
                          </template>
                        </template>
                      </template>
                      <template v-else>
                        Matched
                        <template v-if="hasProperty(reasoningResults, 'phylorefs')">
                          and
                          <template v-if="getNodeLabelsResolvedByPhyloref(phyloref, phylogeny) > 1">
                            <strong>resolved to multiple nodes: {{getNodeLabelsResolvedByPhyloref(phyloref, phylogeny)}}</strong>
                          </template>
                          <template v-else>
                            resolved
                            <template v-if="getNodeLabelsResolvedByPhyloref(phyloref, phylogeny)[0] === getPhylorefExpectedNodeLabels(phylogeny, phyloref)[0]">
                              correctly
                            </template>
                            <template v-else>
                              <strong>incorrectly</strong>
                            </template>
                            to {{getNodeLabelsResolvedByPhyloref(phyloref, phylogeny)[0]||"(none)"}}
                          </template>
                        </template>
                      </template>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </template>

      </div><!-- End of main content div -->
    </div><!-- End of wrapper -->

    <!-- Modal dialogs start here -->

    <!-- About-us modal dialog box: acknowledges funding and links to libraries used -->
    <div id="about-curation-tool" class="modal fade">
      <div class="modal-dialog modal-lg form-horizontal">
        <div class="modal-content">
          <!-- Header of tunit editor modal dialog box -->
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            <h4 class="modal-title">About this tool</h4>
          </div>

          <!-- Body of the about-us modal dialog -->
          <div class="modal-body col-md-12">
            <p>The Phyloreferencing Curation Tool was built as part of the <a href="https://www.phyloref.org">Phyloreferencing project</a>, funded by the US National Science Foundation through collaborative grants <a href="http://www.nsf.gov/awardsearch/showAward?AWD_ID=1458484">DBI-1458484</a> and <a href="http://www.nsf.gov/awardsearch/showAward?AWD_ID=1458604">DBI-1458604</a>. See <a href="http://www.phyloref.org/about/#funding">Funding</a> for details.
            </p>

            <p>The Curation Tool uses a number of open-source libraries, including:</p>

            <ul>
              <li><a href="https://getbootstrap.com/">Bootstrap</a></li>
              <li><a href="https://jquery.com/">jQuery</a></li>
              <li><a href="https://jqueryui.com/">jQuery UI</a></li>
              <li><a href="https://vuejs.org/">Vue.js</a></li>
              <li><a href="https://github.com/veg/phylotree.js">phylotree.js</a>, published as <a href="https://doi.org/10.1186/s12859-018-2283-2">Shank <em>et al</em>, 2018</a></li>
              <li><a href="https://d3js.org/">D3.js</a></li>
              <li><a href="https://momentjs.com/">Moment.js</a></li>
              <li><a href="https://github.com/eligrey/FileSaver.js">FileSaver.js</a></li>
            </ul>
          </div>

          <!-- Footer of the about-us modal dialog -->
          <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>

    <!-- End of modal dialogs -->

  </div><!-- End of page UI -->

    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script
        src="https://code.jquery.com/jquery-3.3.1.min.js"
        integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
        crossorigin="anonymous"
    ></script>
    <script
        src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"
    ></script>
    <script
        src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"
        integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa"
        crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/vue@2.5.13/dist/vue.js"
    ></script>

    <!-- Phylotree -->
    <script src="https://d3js.org/d3.v3.min.js"></script>
    <script src="./lib/phylotree.js/phylotree.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js" charset="utf-8"></script>

    <!-- Moment: for datetime calculations -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.22.2/moment.min.js"></script>

    <!-- FileSaver.js: for saving generated files to the local hard drive -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/1.3.8/FileSaver.min.js"></script>

    <!-- Our source code -->
    <script src="./js/phyx.js"></script>
    <script src="./js/curation-tool.js"></script>

    <!-- Activate window-specific features -->
    <script type="text/javascript"><!--
        $(window).on('beforeunload', (e) => {
            // If someone tries to navigate away from the window while the
            // PHYX has been modified, ask users to confirm before leaving.

            // Confirmation message to display to the user. Note that modern
            // browsers do not display this message, but provide a generic
            // "content has changed" dialog instead.
            var confirmationMessage = 'Your modifications have not been saved and will be lost if you close the Curation Tool. Confirm to discard your changes, or cancel to return to the Curation Tool.';

            if(vm.modified)
                return confirmationMessage;
        });
    //--></script>
</body>

</html>
